function Try(e,r){var t,n=ATOMclone(r);return ATOMextend(n,!0),$("body").append(n),t=adaptMatch(t),n.remove(),t}function overwriteFromHeader(e){GetforAllHeader(e).children().each((function(){var r=this.ATOM_getName(!0);-1==r.indexOf("_")&&(r+="_"),$ATOMParameterSearch(e,$(this)).each((function(){this.ATOM_setName(r)}))}))}function searchForMarkedInSubtree(e,r,t){var n=e.add(e.find("[data-atom]")).filter((function(){var e=ATOMSmarkUnmark($(this),void 0,t);if(e)return"*"==r||allStringAinStringB(r,e)}));return null==n&&(n=$()),n}function getAllMarks(e){for(var r="",t=0;e[t];)r+=ATOMSmarkUnmark($(e[t])),t++;return removeDuplicatesFromString(r)}function allMarksInSubtree(e,r){for(var t=0;r[t];){if(0==searchForMarkedInSubtree(e,r[t]).length)return!1;t++}return!0}function checkMarksOkForPattern(e,r){var t=getAllMarks(searchForMarkedInSubtree(r,"*"));return!t||allMarksInSubtree(e,t)}function allStringAinStringB(e,r){null==e&&(e=""),null==r&&(r="");for(var t=0;e[t];){if(-1==r.indexOf(e[t]))return!1;t++}return!0}function removeDuplicatesFromString(e){for(res="",i=0;e[i];)-1==res.indexOf(e[i])&&(res+=e[i]),i++;return res}function ATOMpath(e,r){for(var t,n,a="ME",o=e;null!=ATOMparent(o)[0]&&(null==r||o[0]!==r[0]);)n="eq"==(t=ATOMparent(o)).attr("data-atom")?o.parent().hasClass("firstMember")?0:1:t[0].ATOM_getChildren().index(o),a=ATOMdescForPath(t)+n+" > "+a,o=t;return a}function ATOMgetOrder(e,r){var t=e.attr("data-path");if(null==t)return-2;for(var n,a=t.split(" > "),o=0,i=a.length;a[i-1-o];){if(n=a[i-1-o].split(/(\d+)/),console.log(n[0]),n[0]==r)return Number(n[1]);o++}return-1}function ATOMdeepGetOrder(e,r){for(var t,n=e.find("[data-atom]").addBack(),a=0,o=[];n[a];)(t=ATOMgetOrder($(n[a]),r))>=0&&o.push(t),a++;return o}function orderUL(e){e.find('[data-atom="eq"]').addBack('[data-atom="eq"]').each((function(e,r){var t=r.ATOM_getRoles(".firstMember").children(),n=r.ATOM_getRoles(".secondMember").children();null!=t&&null!=n&&newATOMcompareOrder(t,n)&&(r.ATOM_getRoles(".firstMember").append(n),r.ATOM_getRoles(".secondMember").append(t))})),e.find(".ul_role").each((function(e,r){var t=$(r.children).filter("[data-atom]");t.sort((function(e,r){return newATOMcompareOrder($(e),$(r))})),t.each((function(e,t){$(r).append(t)}))}))}function newATOMcompareOrder(e,r){var t=ATOMdescForPath(ATOMparent(e)),n=ATOMdeepGetOrder(e,t)[0],a=ATOMdeepGetOrder(r,t)[0];return null!=n&&null!=a?n>a:null==n&&0==a}function ATOMdescForPath(e){var r=ATOMSmarkUnmark(e,void 0,"l");return null!=r&&""!=r?r:e.attr("data-atom")}function ATOMSmarkUnmark(e,r,t){var n=e.attr("title");null==n&&(n="");var a=n.split("-");if(null==r)return"all"==t?n:"p"==t?a[2]?a[2]:"":"l"==t?a[1]?a[1]:"":a[0];if("all"==t)return e.attr("title",r),r;"p"==t?a[2]=r:"l"==t?a[1]=r:"undefined"==t||"m"==t?a[0]=r:a=[r];var o="";for(o=a[0],i=1;i<a.length;)a[i]?o=o+"-"+a[i]:o+="-",i++;return o?e.attr("title",o):e.removeAttr("title"),o}function ATOMappendInABSPosition(e,r,t){$("body").append(e),e.css("position","absolute"),"beside"==t?(e.css("left",r.offset().left+r.width()+12),e.css("top",r.offset().top-75)):(e.css("left",r.offset().left+4),e.css("top",r.offset().top+4))}function TryPropByName(e,r,t,n){var a=newPActx(),o=findAndCloneProp(e,r,n);return o.foundTF&&(ATOMSmarkUnmark(t,"s"),a.$newProp=o.$newProp,a=tryReconfigurableProp(a,t)),a}function tryReconfigurableProp(e,r,t){return overwriteFromHeader((e=PActxFromAttackPoints(e,r,t)).$newProp),(e=cloneOrderMatch(e,!1,!0,!1)).matchedTF&&(containsBvar(e.$transform,e.$newProp)&&(e.$newProp=reformatForallProp(e.$newProp,e.$transform)),e.$transform=e.$equation[0].ATOM_getRoles(".secondMember").children()),debugMode&&e.$newProp.remove(),e}function PActxFromAttackPoints(e,r,t){var n,a=[],o=[r,t];"forAll"===e.$newProp.attr("data-atom")?(a=GetforAllHeader(e.$newProp).children(),e.$equation=GetforAllContent(e.$newProp).children(),e.$pattern=e.$equation[0].ATOM_getRoles(".firstMember").children()):e.$equation=e.$newProp,e.$pattern=e.$equation[0].ATOM_getRoles(".firstMember").children(),e.$transform=e.$equation[0].ATOM_getRoles(".secondMember").children();for(var i=-1,l=0;l<o.length;l++)if(null!=o[l]&&0!=o[l].length){i=l,n=$(o[l]);break}if(-1==i)return e.msg="no $operand could be determined",e.matchedTF=!1,e;var d,s=0,c=ATOMSmarkUnmark(n);if(null!=c)d=e.$pattern.find("[data-atom]").filter((function(){return ATOMSmarkUnmark($(this))==c})).filter(":first");else{var u=$(a[1]);d=$($ATOMParameterSearch(e.$pattern,u)[0])}return 0==d.length?e.$operand=n:(s=levelsToAncestor(d,e.$pattern),e.$operand=0==s?n:$(n.parents("[data-atom]")[s-1])),e}function postRefine(e){let r=searchForMarkedInSubtree(e,"s","p");0!=r.length&&(e.find("[data-atom]").addBack().each((function(){$(this).removeClass("selected")})),r.addClass("selected")),repeatedCleanup(e),e&&e.find("[data-atom]").addBack().each((function(){ATOMSmarkUnmark($(this),"","all"),$(this).removeClass("taken")}))}function cloneOrderMatch(e,r,t,n){var a;if(null==r&&(r=!0),null==t&&(t=!0),a=n?e.$pattern:e.$newProp,r){var o=ATOMclone(e.$pattern);ATOMextend(o,!0)}else o=e.$pattern;return debugMode&&ATOMappendInABSPosition(a,e.$operand,"beside"),debugMode&&(e.$operand.addClass("expandedAsTree"),o.addClass("expandedAsTree"),showAllMarks()),e=adaptMatch(e,e.$operand,o,a),t&&(orderUL(e.$transform),e.$transform.find("[data-atom]").each((function(){$(this).removeAttr("data-path")})),e.$operand.find("[data-atom]").each((function(){$(this).removeAttr("data-path")}))),e.lineList.remove(),r&&debugMode,e}function adaptMatch(e,r,t,n){null==e&&(e={matchedTF:"",msg:"",$span:"",$pattRole:""}),e.matchedTF=!0;var a,o,i=0,l=0,d=!0;for(null==n&&(!0,n=e.$newProp);null!=t[i];){var s=$(),c=ParameterNameToType(t[i].ATOM_getName(!0)),u="x_"==c||"x__"==c||"x___"==c;for(l=0;null!=r[l];)if($(r[l]).hasClass("taken"))l++;else{if(debugMode&&(a=lineAB($(t[i]),$(r[l])),e.lineList=e.lineList.add(a)),compareExtATOM($(r[l]),$(t[i]),!u,!0))if(u)o=!0;else{var f=t[i].ATOM_getChildren(),p=r[l].ATOM_getChildren();o=0==f.length&&0==p.length||(e=adaptMatch(e,p,f,n)).matchedTF}else o=!1;if(o){if($(r[l]).addClass("taken"),s=s.add($(r[l])),debugMode&&a.attr("class","matched"),"x"==c||"x_"==c)break}else debugMode&&a.attr("class","noMatch");l++}if(!("x___"==c||s.length>0)){d=!1;break}if(d=!0,u){s.each((function(){if(-1==ATOMSmarkUnmark($(t[i]),void 0,"p").indexOf("f")){var r=ATOMpath($(this),e.$operand);$(this).attr("data-path",r)}}));var m=replaceInForall($(t[i]),s,n);e.$newProp=m}i++}return debugMode,d?0!=r.filter(':not(".taken")').length?(e.msg="sono avanzati degli input, no match",e.matchedTF=!1):e.matchedTF=!0:(e.msg="alcuni pattern non hanno trovato input richiesti",e.matchedTF=!1),r.removeClass("taken"),e}function PActxViewer(e,r,t){$("*").removeClass("input"),$("*").removeClass("pattern"),r.addClass("input"),t.addClass("pattern")}