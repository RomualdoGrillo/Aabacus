function newPActx(){return{matchedTF:!1,msg:"",$newProp:void 0,$pattern:void 0,$operand:void 0,$transform:void 0,$equation:void 0,replacedAlready:!1,lineList:$()}}class PropertyDnD{constructor(e,t,a,o){this.name=e,this.findTgt=t,this.apply=a,this.onAdd=o}}let propertiesDnD=[new PropertyDnD("associativeDnD",immediateAssValid,ATOMassociate,associateOnAdd),new PropertyDnD("distributiveDnD",validForDist,ATOMdistribute,""),new PropertyDnD("collectDnD",validForColl,ATOMcollect,""),new PropertyDnD("partCollectDnD",validForPartColl,ATOMPartCollect,""),new PropertyDnD("replaceDnD",validReplaced,ATOMLinkReplace,""),new PropertyDnD("forThisDnD",forThisValid,forThisPar_focus_nofocus,"")];function openOnSort(e){if(e.item.classList.contains("toBeCloned")&&e.from.isSameNode(e.to)){let t=e.from.children[e.oldIndex],a=ATOMclone($(e.item))[0];attachEventsAndExtend($(a)),t?e.from.insertBefore(a,t):e.from.append(a)}}function openOnAdd(e){e.item.classList.contains("toBeCloned")||e.clone.remove()}function associateOnAdd(e){e.item.classList.contains("toBeCloned")||e.clone.remove(),console.log("associateOnAdd")}function revert(e){let t=e.from.children[e.oldIndex];t?e.from.insertBefore(e.item,t):e.from.append(e.item),e.clone.remove()}function OpIsAssociative(e){return-1!==["plus","times","or","and"].indexOf(e)}function forThisValid(e){e[0].getAttribute("data-type");let t=tela.querySelectorAll("[data-atom=forAll]"),a=$(),o=0;for(;t[o];)a=a.add(GetforAllHeader($(t[o])).find("[data-atom]")),o++;return a.filter((function(t,a){return typeOk(e,$(a))}))}function immediateAssValid(e){var t=$(e),a=ATOMparent(t);let o=void 0;void 0!==a&&(o=a.attr("data-atom"));var n=$();OpIsAssociative(o)&&(ATOMparent(a).attr("data-atom")===o&&(n=n.add(ATOMparent(a)[0].ATOM_getRoles())),a[0].ATOM_getChildren().each((function(e,t){$(t).attr("data-atom")===o&&(n=n.add(t.ATOM_getRoles()))})));return n}function ATOMassociate(e,t){e.appendTo($(t)),e.css({position:"relative",top:0,left:0}),ATOMcleanIfPointless(t.parent().parent())}function opIsDistDop(e){return"times"===e?"plus":"and"===e?"or":void 0}function validForDist(e){var t=$(e),a=ATOMparent(t);let o=void 0;void 0!==a&&(o=a.attr("data-atom"));let n=opIsDistDop(o);return void 0!==n?($validAtoms=t.siblings().filter("[data-atom="+n+"]"),$validAtoms):[]}function ATOMdistribute(e,t){var a=$(e);let o=ATOMparent(a),n=void 0;void 0!==o&&(n=o.attr("data-atom"));opIsDistDop(n);var l=prototypeSearch(n);$(t)[0].ATOM_getChildren().each((function(){var e=ATOMclone(l),t=ATOMclone(a);attachEventsAndExtend(e),attachEventsAndExtend(t),e.insertBefore($(this)),e[0].ATOM_getRoles().append($(this)),t.css({display:""}),e[0].ATOM_getRoles().append(t)})),e[0].ATOMparent().addClass("cleanPointless"),e.remove()}function validForColl(e){var t=$(e),a=ATOMparent(t),o=void 0;void 0!==a&&(o=a.attr("data-atom"));var n=opIsDistDop(o);if($("*").removeClass("toBeCollected").removeClass("couldBeCollected"),null==a)return $();var l=ATOMparent(a);if(null==n||null==l||l.attr("data-atom")!==n)return $();var r=l[0].ATOM_getChildren();for(i=0;i<r.length;i++){var s=r[i],d=!1;if($(s).attr("data-atom")==o){var c=s.ATOM_getChildren();for(j=0;j<c.length;j++){var p=c[j];if(console.log("controllo factor"),console.log(p),ATOMEqual(p,t[0])){$(p).addClass("couldBeCollected"),d=!0;break}}}else ATOMEqual(s,t[0])&&($(s).addClass("couldBeCollected"),d=!0);if(!1===d)return console.log("term without such factor"),console.log(s),$()}return console.log("okForCollection"),l}function validForPartColl(e){var t=$(e),a=ATOMparent(t),o=$(),n=void 0;void 0!==a&&(n=a.attr("data-atom"));var l=opIsDistDop(n);if($("*").removeClass("toBeCollected").removeClass("couldBeCollected"),null==a)return $();var r=ATOMparent(a);if(null==l||null==r||r.attr("data-atom")!==l)return $();var s=a.siblings("[data-atom]");for(i=0;i<s.length;i++){var d=s[i];if($(d).attr("data-atom")==n){var c=d.ATOM_getChildren();for(j=0;j<c.length;j++){var p=c[j];if(console.log("controllo factor"),console.log(p),ATOMEqual(p,t[0])){$(p).addClass("couldBeCollected"),!0,o=o.add(p);break}}}else ATOMEqual(d,t[0])&&($(d).addClass("couldBeCollected"),!0,o=o.add(d))}return o}function ATOMPartCollect(e,t){ATOMparent(t).attr("data-atom");let a=ATOMparent(e);e.siblings("[data-atom]"),a.attr("data-atom")}function ATOMcollect(e,t){let a=ATOMparent(e),o=void 0;void 0!==a&&(o=a.attr("data-atom")),console.log("collect"),encaseIfNeeded(t,o),$cloneDragged=ATOMclone(e),ATOMparent($(".couldBeCollected")).addClass("cleanPointless"),$cloneDragged.removeClass("couldBeCollected"),attachEventsAndExtend($cloneDragged),$cloneDragged.insertBefore(t),$cloneDragged.css({display:""}),$(".couldBeCollected").remove(),t.addClass("cleanPointless")}function compose(e){var t=e,a=newPActx(),o=ATOMparent(e).attr("data-atom");if(0==e.length)return a.msg="nothing selected",a;if(1==e.length){var n,l=e.attr("data-atom");if("cn"===l||"ci"===l)e[0].ATOM_getName();(n="row"===e.parent().css("flex-direction")?$(".selected").prevAll("[data-atom]:first"):$(".selected").nextAll("[data-atom]:first")).addClass("selected"),e=e.add(n),$("*").removeClass("toBeComposed"),ATOMnodesAddClass(e,"toBeComposed")}if(!checkSiblings(e))return a.msg="not siblings",a;if(ATOMSmarkUnmark(e,"d"),"plus"!==o&&"times"!==o&&"or"!==o)return a.msg="no composition defined for: "+o,a;for(var r=void 0,s=0,i=e.length;s<i;s++){var d=AtomsToVal($(e[s]));if(0==d.val&&-1==d.exp){console.warn("1/0 is meaningless"),a.matchedTF=!1;break}if("cn"!==d.type&&"ci"!==d.type){r=d,a.matchedTF=!1;break}if(null==r)r=d;else if("times"===o)if(r.sign=r.sign*d.sign,1==r.val)r.val=d.val,r.exp=d.exp,r.type=d.type,a.matchedTF=!0;else if(1==d.val)a.matchedTF=!0;else if(r.val===d.val&&r.exp==-1*d.exp)r.exp=1,r.val=1,r.type="cn",a.matchedTF=!0;else{if("cn"!==d.type||"cn"!==r.type||r.exp!=d.exp){a.matchedTF=!1;break}r.val=r.val*d.val,a.matchedTF=!0}else if("plus"===o)if(0==r.val)r=d,a.matchedTF=!0;else if(0==d.val)a.matchedTF=!0;else if("cn"===d.type&&"cn"===r.type){var c=d.val*d.sign+r.val*r.sign;r.val=Math.abs(c),r.sign=Math.sign(c),a.matchedTF=!0}else{if("ci"!==d.type||"ci"!==r.type||d.exp!=r.exp||d.sign!=-1*r.sign)break;r.val=0,r.exp=1,r.sign=1,a.matchedTF=!0}else if("and"===o){r=d;break}}return 1==a.matchedTF?(a.$transform=ValToAtoms(r),a.$transform.addClass("selected"),a.$operand=e,a.msg="compose"):($(".selected").removeClass("selected"),t.addClass("selected"),ATOMSmarkUnmark(e,"")),a}function decompose(e,t){var a=newPActx();a.$operand=e,a.$transform=ATOMparent(e);var o="",n="",l=e.attr("data-type");if(1===e.length){var r=AtomsToVal(e);if("num"===l)if("up"===t){if(o="times","minus"===e.attr("data-atom")){var s=e,i=ValToAtoms({type:"cn",val:1,sign:-1,exp:1}),d=ATOMparent(s),c=s[0].ATOM_getChildren();n=d,"times"==d.attr("data-atom")?i.insertBefore(s):("times"!==c.attr("data-atom")&&(c=encaseWithOperation(c,"times")),c[0].ATOM_getRoles().prepend(i)),c.insertAfter(s),s.remove(),e=c,i.addClass("selected"),a.matchedTF=!0}else if("cn"===r.type){var p=Number(ATOMNumericCdsAsText(e)),m=primeFactorization(p);if(m.length>1){n=encaseIfNeeded(e,o);var f=prototypeSearch("num");m.forEach((function(t,a){$clone=ATOMclone(f),$clone.attr("data-atom","cn"),attachEventsAndExtend($clone),$clone[0].ATOM_setName(t),$clone.insertAfter(e),a==m.length-1&&$clone.addClass("selected")})),e.remove(),a.matchedTF=!0}}if(!a.matchedTF&&1!=p){n=encaseIfNeeded(e,o);ValToAtoms({type:"cn",val:1,sign:1,exp:1}).insertAfter(e),a.matchedTF=!0}}else if("right"===t&&(o="plus","cn"===r.type&&r.val%1==0&&r.val>1&&1==r.exp)){n=encaseIfNeeded(e,o);var v={type:"cn",val:1,sign:r.sign,exp:1};(i=ValToAtoms(v)).insertBefore(e),r.val=r.val-1;var u=ValToAtoms(r);e.replaceWith(u),(e=u).addClass("selected"),a.matchedTF=!0}return a.matchedTF&&(RefreshEmptyInfixBraketsGlued(n,!0,"eibg"),ssnapshot.take(),a.replacedAlready=!0,a.msg="decompose"),a}console.log("cant decompose "+e.length+" elements")}function validReplaced(e){var t=$(e),a=ATOMparent(t),o=a.find(">.firstMember * , >.secondMember *");return t.parent().hasClass("firstMember")||t.parent().hasClass("secondMember")?PropositionValidSpan(a).filter(":visible").not(o).filter((function(e){return ATOMEqual(this,t[0],!1,!0)})):[]}function $identifierSpan(e){for(var t=$(".selected").parents("[data-atom=forAll]"),a=0;t[a];){if(parameterInHeader(e,$(t[a])))return $(t[a]);a++}return $("#telaRole")}function highlightOccurrences(e){var t=$identifierSpan(e);$ATOMParameterSearch(t,e).not(e).each((function(){lineAB($(this),e)}))}function evaluateComparison(e){var t=newPActx();t.$operand=e;var a=e.attr("data-atom");if(-1!=["eq","gt","lt","geq","leq"].indexOf(a)){var o=e[0].ATOM_getRoles(".firstMember").children(),n=AtomsToVal(o),l=e[0].ATOM_getRoles(".secondMember").children(),r=AtomsToVal(l);if(!isNaN(n.computedVal)&&!isNaN(r.computedVal)){var s,i,d=prototypeSearch("bool");(a="eq")?s=n.computedVal=r.computedVal:(a="gt")?s=n.computedVal>r.computedVal:(a="geq")?s=n.computedVal>=r.computedVal:(a="lt")?s=n.computedVal<r.computedVal:(a="leq")&&(s=n.computedVal<=r.computedVal),i=s?"true":"false";var c=ATOMclone(d);attachEventsAndExtend(c),c[0].ATOM_setName(i),c.insertAfter(e),c.addClass("selected"),e.remove(),t.matchedTF=!0,t.replacedAlready=!0,t.msg="composeInequation"}}return t}function forThisPar_focus_nofocus(e,t){let a;if(ATOMparent(t).hasClass("exclusiveFocus"))a=ATOMparent(t);else{let e=t.index();a=createForThis(ATOMparent(t),ATOMparent(t)),t=$(GetforAllHeader(a).children()[e])}ATOMForThisPar(t,e)}