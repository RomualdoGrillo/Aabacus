function ATOMextend(e,t){(t?e.filter("[data-atom]").add(e.find("[data-atom]")):e.filter("[data-atom]")).each((function(e){$.extend(this,atom)}))}function ATOMparent(e){return null==e&&(e=$(this)),e.parent().closest("[data-atom]")}function ATOMclosedDef(e){return 0==$(e).closest(".unlocked").length}function ATOM_dissolveContainer(){if(this.ATOM_getChildren().length>0){var e=this.ATOM_getRoles().children().filter("[data-atom]");$(this).replaceWith(e)}else $(this).remove();console.log("removed container"),console.log(this)}function ATOMCreateDefinition(e){null==e&&(e=this);var t=$(this).attr("data-type"),a=ATOMclone(prototypeSearch("eq")),n=ATOMclone(prototypeSearch("function"));n.attr("data-type",t),m1=a.find(".firstMember"),newName=prompt("Enter a new name"),n.attr("data-atom",newName),n.append(newName),m1.append(n),$definens=ATOMclone($(e)),m2=a.find(".secondMember"),m2.append($definens);var r=$definens.find(".unselected");return r.length>0&&($newforAll=ATOMclone(prototypeSearch("forAll")),$("#telaRole").append($newforAll),GetforAllContent($newforAll).append(a),r.each((function(e,t){var a=$(this).attr("data-type"),r=ATOMclone(prototypeSearch()).attr("data-type",a);r.append("p"+e),$(this).replaceWith(r);var o=ATOMclone(r),s=ATOMclone(r),l=$('<span class="s_role" data-accept="1"></span>');l.attr("data-type",a),n.append(l),l.append(o),GetforAllHeader($newforAll).append(s)}))),a.find("*").removeClass("selected").removeClass("unselected"),attachEventsAndExtend($newforAll),e}function ATOMReplace(e,t){var a=ATOMclone(t);ATOMextend(a);var n=ATOMSmarkUnmark(e);void 0!==n&&ATOMSmarkUnmark(a,n),e.replaceWith(a),a.css({display:""}),attachEventsAndExtend(a)}function ATOMLinkReplace(e,t){ATOMReplaceLink(t,e)}function ATOMReplaceLink(e,t){var a;t.parent().hasClass("firstMember")?a=ATOMclone(ATOMparent(t)[0].ATOM_getRoles(".secondMember").children()):t.parent().hasClass("secondMember")?a=ATOMclone(ATOMparent(t)[0].ATOM_getRoles(".firstMember").children()):console.log("dragged ne primo ne secondo membro"),t.hasClass("minus")!==e.hasClass("minus")&&a.toggleClass("minus"),t.hasClass("inverse")!==e.hasClass("inverse")&&a.toggleClass("inverse"),e.replaceWith(a),attachEventsAndExtend(a)}function typeOk(e,t){return classA_in_classB(e.attr("data-type"),t.attr("data-type"))}function classA_in_classB(e,t){return"obj"===t||e===t}function ATOMCreateSpaceForDeduction(e){var t;if("and"===ATOMparent(e).attr("data-atom"))t=e.parent();else{var a=ATOMclone(prototypeSearch("and"));attachEventsAndExtend(a),e.parent().append(a),(t=a.find('>[class*="_role"]')).append(e)}return t}function $ATOMParameterSearch(e,t){return e.find("[data-atom]").filter((function(e){return compareExtATOM(t,$(this),!0,!1)}))}function ATOMReplaceAll(e,t,a){$(t);var n=$(a),r=$ATOMParameterSearch(e=$(e),t);$.each(r,(function(e,t){ATOMReplace($(t),n)}));return+r.length+" replaced"}function GetforAllContent(e){return e[0].ATOM_getRoles(".forAllContent")}function GetforAllHeader(e){return e[0].ATOM_getRoles(".forAllHeader")}function ATOMForThis_Par_newVal(e,t){return ATOMForThisPar(t,e)}function ATOMForThisPar(e,t){var a=e.parent().closest('[data-atom="forAll"]'),n=GetforAllHeader(a),r=GetforAllContent(a),o=a;if(0!=t.length){var s=t[0].ATOM_getName();n.children().filter((function(){return this.ATOM_getName()==s})).each((function(){formatForall(a,$(this))}))}if(ATOMReplaceAll(r,e,t),e.remove(),0==n.children().length){var l=r.children();"absolute"==a.css("position")?ATOMappendInABSPosition(l,a,"superposed"):l.insertBefore(a),a.remove(),o=l}return o}function formatForall(e,t){var a="("+t[0].ATOM_getName()+")";$ATOMParameterSearch(e,t).each((function(){this.ATOM_setName(a)}))}function ATOM_replaceWith(e){return $(this.ATOM_getEnclIfPresent()).replaceWith(ATOM_getEnclIfPresent(e)),this}function ATOM_getNodes(e){$(this).addClass("gettingNodes");var t=$(this).find("*").not(".gettingNodes [data-atom], .gettingNodes [data-atom] *"),a=$(this).add(t);return null!=e&&(a=a.filter(e)),$(this).removeClass("gettingNodes"),a}function ATOM_getRoles(e){var t=this.ATOM_getNodes(e).filter('[class*="_role"]');return t.sort((function(e,t){return $(e).hasClass("bVar_role")&&!$(t).hasClass("bVar_role")?-1:$(t).hasClass("bVar_role")&&!$(e).hasClass("bVar_role")?1:parseInt($(e).attr("data-roleOrder"))>parseInt($(t).attr("data-roleOrder"))?1:parseInt($(t).attr("data-roleOrder"))>parseInt($(e).attr("data-roleOrder"))?-1:0})),t}function ATOM_getChildren(e){var t=this.ATOM_getRoles().children("[data-atom]");return null!=e&&(t=t.filter(e)),t}function ATOM_getName(e){var t=$(this).find(">.name").text();return e?t:t.match(/[^_]*/)[0]}function ATOM_setName(e){$(this).find(">.name").text(e)}function ATOM_addRole(e,t){var a;return a=$('<span class="role">'+t+"</span>").attr("data-type",e),$(this).append(a),a}function validTargetsFromOpened(e){var t;return $('#telarole, #telarole [class*="_role"]').filter((function(a){return t=getNumOfPlaces($(this)),(!ATOMclosedDef(this)||e.is("#asymmeqPrototype")||e.is("#boolPrototype"))&&typeOk(e,$(this))&&(-1===t||$(this).children().filter("[data-atom]").length<t)}))}function getNumOfPlaces(e){return e.hasClass("s_role")?numOfPlaces=1:void 0===e.attr("data-accept")||-1===parseInt(e.attr("data-accept"))?numOfPlaces=-1:numOfPlaces=parseInt(e.attr("data-accept")),numOfPlaces}function overflowExsists(e){return e.offsetHeight<e.scrollHeight||e.offsetWidth<e.scrollWidth}function ATOMclone(e,t){return $clone=e.clone(),$toBeCleaned=$clone.add($clone.find("*")),!1!==t&&$toBeCleaned.removeAttr("id"),$toBeCleaned.removeClass((function(e,t){return(t.match(/(^|\s)ui-\S+/g)||[]).join(" ")})),$toBeCleaned.removeClass((function(e,t){return(t.match(/(^|\s)target-\S+/g)||[]).join(" ")})),$toBeCleaned.removeClass("born"),$clone}function prototypeSearch(e,t,a){var n=void 0===t?"[data-type]":"[data-type="+t+"]",r=$("#"+e.toLowerCase()+"Prototype"+n);return 0===r.length&&((r=ATOMclone($("#Prototype"))).attr("data-atom",e),r.attr("data-type",t)),r}atom={ATOMparent:ATOMparent,ATOMcleanIfPointless:ATOMcleanIfPointless,ATOMclosedDef:ATOMclosedDef,ATOMCreateDefinition:ATOMCreateDefinition,ATOM_replaceWith:ATOM_replaceWith,ATOM_getNodes:ATOM_getNodes,ATOM_getRoles:ATOM_getRoles,ATOM_getChildren:ATOM_getChildren,ATOM_getName:ATOM_getName,ATOM_setName:ATOM_setName,ATOM_createMathmlString:ATOM_createMathmlString,ATOM_addRole:ATOM_addRole,ATOM_checkIfPointlessSingleNode:ATOM_checkIfPointlessSingleNode,ATOM_dissolveContainer:ATOM_dissolveContainer,ATOM_overlay:ATOM_overlay};var symbols=["ci","cn","csymbol"];function prototypeSearch2(e,t,a,n){var r=void 0===a?"[data-type]":"[data-type="+a+"]",o=$("#"+e.toLowerCase()+"Prototype"+r);if(o.length=0,-1!=symbols.indexOf(e)){if("cn"===e!=!isNaN(t))throw"incoerenza cn symbolname";if(o.length>1)for(var s=0;o[s];)o[++s].text()==t&&($prototype=$(o[s]),s=-1)}return $prototype&&($prototype=$(o[0])),$prototype}function encaseWithOperation(e,t){var a=ATOMclone(prototypeSearch(t));return attachEventsAndExtend(a),a.insertBefore(e),e.appendTo(a[0].ATOM_getRoles()),ssnapshot.take(),a}function encaseIfNeeded(e,t){return ATOMparent(e).attr("data-atom")===t?ATOMparent(e):encaseWithOperation(e,t)}function checkCn(e){for(var t=!0,a=0,n=e.length;a<n;a++)if(isNaN($(e[a]).text())){t=!1;break}return t}function checkSiblings(e){for(var t=!0,a=ATOMparent($(e[0])),n=0,r=e.length;n<r;n++)if(!ATOMparent($(e[n])).is(a)){t=!1;break}return t}function addTypeDecorations(e){var t=e.attr("data-type"),a=e;("num"===t&&0==a.find(".leftDecoration").length&&a.append($('<span class="leftDecoration"></span>')),"num"!==t&&"bool"!==t||0!=a.find(".topDecoration").length)||(a=e).append($('<span class="topDecoration"></span>'))}function ATOMrenamePrompt(e,t){var a=e[0].ATOM_getName();e.hasClass("minus")&&(a="-"+a),e.hasClass("inverse")&&(a="/"+a),null!=(t=prompt('Enter a new name, / for inverse, /- for opposite and inverse do not use "-" or "/" in names es: x-xxx ',a))&&("/"===t[0]?(t=t.substr(1),e.addClass("inverse")):e.removeClass("inverse"),"-"===t[0]?(t=t.substr(1),e.addClass("minus")):e.removeClass("minus"),e[0].ATOM_setName(t),e.attr("data-atom",isNaN(t)?"ci":"cn"),ssnapshot.take())}function createForThis(e,t){var a=ATOMclone(e);return exclusiveFocus=a.addClass("exclusiveFocus"),attachEventsAndExtend(a),"and"==ATOMparent(e).attr("data-atom")?a.insertAfter(e):ATOMCreateSpaceForDeduction(e).append(a),a}function AtomsToVal(e,t){debugMode&&($("*").removeClass("input"),ATOMnodesAddClass(e,"input")),null==t&&(t={type:"NotAnumber",val:1,sign:1,exp:1,computedVal:NaN,canBeReplaced:!0});var a=e.attr("data-atom");if("minus"===a||"m_inverse"===a){var n=AtomsToVal(e[0].ATOM_getChildren(),t);"minus"===a?t.sign=-1*n.sign:t.exp=-1*n.exp}else"cn"===a||"ci"===a?(t.type=a,t.val=e[0].ATOM_getName()):(t.val=NaN,t.canBeReplaced=!1);return t.computedVal=Math.pow(t.sign*t.val,t.exp),t}function isAsymbol(e){var t=e.attr("data-atom");return-1!=symbols.indexOf(t)}function ValToAtoms(e){var t,a,n;return-1===e.sign&&(a=ATOMclone(prototypeSearch("minus")),attachEventsAndExtend(a),t=a,n=a[0].ATOM_getRoles()),-1===e.exp&&(a=ATOMclone(prototypeSearch("m_inverse")),attachEventsAndExtend(a),void 0!==n?n.append(a):t=a,n=a[0].ATOM_getRoles()),a=ATOMclone(prototypeSearch("num")),attachEventsAndExtend(a),a[0].ATOM_setName(e.val),a.attr("data-atom",e.type),void 0!==n?n.append(a):t=a,t}function AtomBesideGiven(e){return"inline-block"===$toBeComp.css("display")?e.prevAll("[data-atom]:first"):e.nextAll("[data-atom]:first")}function ATOMneedsBracket(e){var t=e.attr("data-atom"),a=ATOMparent(e).attr("data-atom"),n=["plus","times","minus"].indexOf(t);return-1!=n&&-1!=[["plus","times","power"],["times","power"],[]][n].indexOf(a)}function refreshOneBracket(e){ATOMneedsBracket(e)?e.addClass("brackets"):e.removeClass("brackets")}function generalRefreshInfixEmptyBrakets(e,t,a,n){(t||a||n?e.add(e.find("[data-atom]")):e).each((function(e,r){(0==e||t)&&refreshOneInfix($(r)),(0==e||a)&&refreshEmpty($(r)),(0==e||n)&&refreshOneBracket($(r))}))}function RefreshEmptyInfixBraketsGlued(e,t,a){(0!=t?e.add(e.find("[data-atom]")):e).each((function(e,t){null!=a&&-1==a.indexOf("e")||refreshEmpty($(t)),null!=a&&-1==a.indexOf("i")||refreshOneInfix($(t)),null!=a&&-1==a.indexOf("b")||refreshOneBracket($(t))})),null!=a&&-1==a.indexOf("g")||refreshGlued(e)}function ATOMshowMarks(e,t){var a=e.attr("title");null==a&&(a="");var n=e.attr("data-path");t&&null!=n||(n=""),0==e.find(".label").length&&e.append('<div class="label"></div>'),e.find(".label").text(a+"_"+n)}function showAllMarks(e){$("body [data-atom]:visible").each((function(t,a){ATOMshowMarks($(a),e)}))}function ATOMEqual(e,t,a,n){return null!=e&&null!=t&&e.ATOM_createMathmlString(a,n)===t.ATOM_createMathmlString(a,n)}function compareExtATOM(e,t,a,n){return!(n&&!checkMarksOkForPattern(e,t))&&(e.attr("data-type")===t.attr("data-type")&&(0==a||e.attr("data-atom")===t.attr("data-atom")&&(-1==symbols.indexOf(e.attr("data-atom"))||e[0].ATOM_getName()===t[0].ATOM_getName())))}function ATOMcleanIfPointless(e,t){if(t)for(i=0;i<100;i++){var a=$(e).find("[data-atom]").filter((function(){return this.ATOM_checkIfPointlessSingleNode()}));if(!(a.length>0))return;a[0].ATOM_dissolveContainer()}else $(e).is("[data-atom]")&&$(e)[0].ATOM_checkIfPointlessSingleNode()&&$(e)[0].ATOM_dissolveContainer()}function ATOM_checkIfPointlessSingleNode(){return $(this).is('[data-atom="plus"],[data-atom="times"],[data-atom="or"],[data-atom="and"]')&&1==this.ATOM_getChildren().length}function PropositionValidSpan(e,t){null==t&&(t=!0);for(var a=e,n=e.parents("[data-atom]"),r=0;n[r]&&"and"==$(n[r]).attr("data-atom");)a=$(n[r]),r++;return validPropDiscendence(a,t)}function validPropDiscendence(e,t){var a=$();return e.each((function(){var e=$(this).attr("data-atom"),n=this.ATOM_getChildren();n&&("and"!=e&&0==t||(a=(a=a.add(n)).add(validPropDiscendence(n,t))))})),a}function ATOM_overlay(e){null==e?$(this).append('<div id="overlay">'):$("#overlay").remove()}function ATOMnodesAddClass(e,t,a){a?e.each((function(){this.ATOM_getNodes().removeClass(t)})):e.each((function(){this.ATOM_getNodes().addClass(t)}))}