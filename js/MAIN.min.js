let exclusiveFocus,debugMode=!1,tela=document.getElementById("telaRole"),sorting=!1;$("input[type=radio][name=color]").change((function(){console.log(this.value),$("body").removeClass("whiteBorders greyBorders coloredBorders"),$("body").addClass(this.value)})),ssnapshot();let sortablesSelectorString=".ul_role,.ol_role,.s_role:not(.unsortable)",initialSortables=document.querySelectorAll(sortablesSelectorString);function ATOMNselectable(e){return ATOMtarget=e.closest("[data-atom]:not(.unselectable)")}function clickHandler(e){let t=ATOMNselectable($(e.target));if("start"==e.type)$("[data-atom]").removeClass("selected").removeClass("unselected"),$(e.item).addClass("selected"),e.clone&&$(e.clone).addClass("selected");else if($(e.target).is(".asymmetric>.firstMember")){let t=$(e.target).parent();t.toggleClass("unlocked"),refreshAsymmEq(t),ssnapshot.take()}else e.ctrlKey?t.hasClass("selected")?t.find("[data-atom]").removeClass("selected").removeClass("unselected"):0!=t.closest(".selected").length||t.addClass("selected"):e.shiftKey?t.hasClass("selected")?(t.removeClass("selected"),t.find("[data-atom]").removeClass("selected").removeClass("unselected")):t.hasClass("unselected")?(t.removeClass("unselected"),t.find("[data-atom]").removeClass("selected").removeClass("unselected")):0!=t.closest(".selected").length&&0==t.closest(".unselected").length&&(t.addClass("unselected"),t.find("[data-atom]").removeClass("selected").removeClass("unselected")):t.hasClass("selected")?$("[data-atom]").removeClass("selected").removeClass("unselected"):($("[data-atom]").removeClass("selected").removeClass("unselected"),t.addClass("selected"))}function dblclickHandler(e){let t=ATOMNselectable(e.target),l=$(t),s=l.attr("data-atom"),a=ATOMclosedDef(l);if(console.log("dblclick"),a&&"ci"===s&&"forAll"==ATOMparent(l).attr("data-atom")){var o=prompt("Specify a value");if(null!=o){var n=l.attr("data-type"),c=ATOMclone(prototypeSearch(isNaN(o)?"ci":"cn"));attachEventsAndExtend(c),c[0].ATOM_setName(o),c.attr("data-type",n),forThisPar_focus_nofocus(c,l),ssnapshot.take()}}else a&&"forAll"===s?l.hasClass("exclusiveFocus")&&(l.removeClass("exclusiveFocus"),exclusiveFocus=""):a&&"plus"===s?(l.hasClass("resizable")&&(l[0].ATOM_getRoles().css("width",""),l[0].ATOM_getRoles().css("height","")),l.toggleClass("resizable")):"defTrue"===s?l.toggleClass("expanded"):"ci"!=s&&"cn"!=s&&"plus"!=s?l.toggleClass("minimized"):a||"ci"!=s&&"cn"!=s||ATOMrenamePrompt(l)}function clearTarget(e){"string"==typeof e&&(e=[e]),document.querySelectorAll(sortablesSelectorString).forEach((function(t){t.classList.remove(...e)}))}function refreshAsymmEq(e){var t=e.find(">.firstMember");t.addClass("ui-icon"),e.hasClass("unlocked")?(t.addClass("ui-icon-unlocked"),t.removeClass("ui-icon-bullet")):(t.addClass("ui-icon-bullet"),t.removeClass("ui-icon-unlocked"))}function keyToCharacter(e){return 37===e?"←":38===e?"↑":39===e?"→":40===e?"↓":String.fromCharCode(e)}function refreshAndReplace(e){var t;return console.log("Applied property: "+e.msg),1==e.replacedAlready?t=ATOMparent(e.$transform):(t=ATOMparent(e.$operand),e.$transform.insertBefore(e.$operand[0]),e.$operand.remove(),attachEventsAndExtend(e.$transform,!0,!0)),void 0!==t&&0!=t.length&&(RefreshEmptyInfixBraketsGlued(t,!0,"gi"),ATOMcleanIfPointless(t,!1)),e}function debugToggle(){debugMode=!debugMode,debugMode?($("#telaRole").addClass("debug"),$("#tavolozza").addClass("hidden")):($("#telaRole").removeClass("debug"),$("#tavolozza").removeClass("hidden"))}function attachEventsAndExtend(e,t,l){var s;!1!==t?(0!=l&&ATOMextend(e,!0),s=e.add(e.find('[data-atom],[class*="_role"]'))):(0!=l&&ATOMextend(e,!0),s=e[0].ATOM_getNodes()),s.filter("[data-atom].asymmetric").each((function(e,t){refreshAsymmEq($(t))})),s.filter("[data-atom].asymmetric").each((function(e,t){refreshAsymmEq($(t))}));let a=s.filter(sortablesSelectorString).toArray();makeSortable(a)}function cancelSelected(){toBeCancelled=$(".selected").filter((function(e){return!ATOMclosedDef(this)})),0!=toBeCancelled.length&&(toBeCancelled.each((function(e,t){console.log($(t).remove())})),ssnapshot.take())}function swapElements(e,t){var l=document.createElement("div");e.parentNode.insertBefore(l,e),t.parentNode.insertBefore(e,t),l.parentNode.insertBefore(t,l),l.parentNode.removeChild(l)}makeSortable(initialSortables),$("[data-atom].asymmetric").each((function(e,t){refreshAsymmEq($(t))})),ATOMextend($("body"),!0),RefreshEmptyInfixBraketsGlued($("body"),!0,"eib"),ssnapshot.take(),document.addEventListener("click",clickHandler),document.addEventListener("dblclick",dblclickHandler),$(document).on("keydown",(function(e){var t=keyToCharacter(e.which).toLowerCase();if(console.log("key pressed:"+t+" code: "+e.which),e.ctrlKey&&"a"===t)$("#telaRole *").removeClass("selected"),$("#telaRole>[data-atom]").addClass("selected");else if(e.ctrlKey&&"c"===t)ssnapshot.copy(),console.log("control + c");else if(e.ctrlKey&&"v"===t)ssnapshot.paste(),console.log("control + v");else if(e.ctrlKey&&"z"===t)ssnapshot.undo(),console.log("control + z");else if(e.ctrlKey&&"x"===t)ssnapshot.copy(),cancelSelected(),console.log("control + x");else if(46===e.which||8===e.which)cancelSelected(),console.log("canc or del");else if(e.shiftKey&&"d"===t)debugToggle(),console.log("control + d");else if(e.shiftKey&&"s"===t){var l;if(console.log("Shift + s"),0!=(l=0==$(".selected").length?$("#telaAnd")[0].ATOM_getChildren():$(".selected")).length){var s='<math xmlns="http://www.w3.org/1998/Math/MathML">'+createMathmlString(l,!0)+"</math>",a=prompt('Save as... Attenzione: Il file verrà salvato nella cartella "Download" !! non è possibile salvare in altre cartelle');null!==a&&saveTextAsFile(s,a+".mml")}}else if(e.shiftKey&&"l"===t)console.log("Shift + l"),$("#fileToLoad").trigger("click");else{var o=newPActx(),n=$(".selected");38===e.which?o=decompose(n,"up"):39===e.which?o=decompose(n,"right"):40!==e.which&&37!==e.which||(o=compose(n)),o.matchedTF||(o=keyboardEvToFC(n,t)),1==o.matchedTF&&(refreshAndReplace(o),postRefine(o.$transform),ssnapshot.take())}})),$("#create-link").click((function(){$(".selected")[0].ATOMCreateDefinition()})),$("#help-link").click((function(e){window.open("./Help/Help.html")})),$("#fileToLoad").change((function(){console.log("fileTOLoad change");var e=jQuery("#fileToLoad")[0].files[0],t=$("#telaRole");loadFileConvert(e,$(t[0]),"mml_aab"),this.value=""}));